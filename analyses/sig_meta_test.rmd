---
title: "Significant Metabolites Analysis - Test Set"
author: "Jeremy Ash"
date: "May 17, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(car)
library(ChemmineR)
library(lme4)
library(perm)
```

# Normalization and log transformation

```{r cars}
rm(list = ls())
sdfset <- read.SDFset("common_test_training_molecule-v2.sdf")

# test for significance with only compounds that have chemical structures

f1 <- read.delim(file = "sample_factors_test.txt", header = T, row.names = 1)
f2 <- read.table(file = "sample_metabolites_test.txt", header = T, row.names = 1)
f1 <- na.omit(f1)
rownames(f1) <- f1$Sample_name
f1$Subject_name <- gsub("P_|S_", "", f1$Subject_name, perl = T)

f1 <- f1[, -2]
colnames(f1) <- c("Patient","Organ", "Health_State", "Smoking_Status", "Gender")
head(f1)

f2 <- t(f2)

# save this processed data frame so you can try different processing
before.process <- f2

save.image("test_set.rda")


# two metabolites with missing values, use imputation, take half the minimum
# of that metabolite's value
# also, perform log base 2 transformation.  I cannot for the life of me
# figure out how they did their normalization
f2 <- apply(f2, 2, function(x) {
  # idx <- which(is.na(x))
  x[is.na(x)] <- .5*min(na.omit(x))
  # print(x[idx])
  x
})

# # not necessary to do total quantity normalization
# # pvalues dont change see below
# for(i in 1:nrow(f2)){
#   f2[i, ] <- f2[i, ]/sum(f2[i, ])
# }

# log transformation
f2 <- log(f2, base = 2)

summary(f2[, 1:6])
hist(f2[, "asparagine"])

# fix compound names so that they are the same
# format as the file provided by Melaine
ids <- sdfid(sdfset)
ids.new <- gsub(" |,","_",ids, perl = T)

# 130 compounds provided
sum(ids.new %in% colnames(f2))
dim(f2)

f2 <- f2[, colnames(f2) %in% ids.new]
rownames(f2) <- sub("X", "", row.names(f2))
head(f1)
d <- merge(f1, f2, by.x= "row.names", by.y = "row.names")

d$Organ <- factor(d$Organ)

#replacing mispelled adenocarcinoma and "Adenosquamous" with Adenocarcinoma
d$Health_State <- gsub("Adenocarcnoma|Adenosquamous", "Adenocarcinoma", d$Health_State)

table(d$Organ, d$Health_State)

table(d$Organ, d$Smoking_Status)
table(d$Organ, d$Smoking_Status, d$Health_State)
table(d$Organ, d$Gender)
table(d$Organ, d$Gender, d$Health_State)
# table(d$Organ)
# table(d$Smoking_Status)
# table(d$Gender)
# table(d$Health_State)
# table(d$Patient)

# some patients do not have measurements for both plasma and serum
head(xtabs(`1_5-anhydroglucitol` ~ Patient + Organ, d))

row.names(d) <- d$Row.names
d$Row.names <- NULL

save.image("test_set_tq_nonormalize.rda")
```

## T-Tests for Significant differences

```{r pressure}
vars = colnames(d)[6:ncol(d)]
varNum <- length(vars)
pkimodels <- vector("list", (varNum))
pkimodelspvals <- vector("list", (varNum))
pkimodelseffect <- vector("list", (varNum))
pkimodelsmean <- vector("list", (varNum))

#----controling for all factors, including organ

for (i in 1:(varNum)){
  lmfit <- lm(d[,i+5]~ Organ + Health_State + Smoking_Status + Gender, data = d)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>F)`[3]
  pkimodelseffect[[i]] <- log(mean(2^(d[d$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d[d$Health_State == "Healthy",i+5])), base=2)
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
plot(pki_ps, pki_effect)
log2FoldChange <- pki_effect

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps, log2FoldChange = log2FoldChange)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sig_no_block <- univariate_res_control$pvalues < .05
write.csv(univariate_res_control, "healthstate_anova_wsig_control_test.txt", row.names = F)

#-----Using patient as blocking factor

for (i in 1:(varNum)){
  lmfit <- lmer(d[,i+5]~ Organ + Health_State + Smoking_Status + Gender + (1|Patient), data = d)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>Chisq)`[3]
  
  pkimodelseffect[[i]] <- mean(2^(d[d$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d[d$Health_State == "Healthy",i+5]))
  # mins[[i]] <- min(d[,220])
}

pki_effect = unlist(pkimodelseffect)
log2FoldChange <- pki_effect

pki_ps_raw = unlist(pkimodelspvals)
plot(pki_ps_raw, pki_effect)
pki_ps_adj <- p.adjust(pki_ps_raw, method = "BH")
plot(pki_ps_adj, pki_effect)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps_raw,
                                    adj_pvalues = pki_ps_adj,
                                    FoldChange = log2FoldChange)
univariate_res_control$significance_raw <- univariate_res_control$pvalues < .05
univariate_res_control$significance_adj <- univariate_res_control$adj_pvalues < .05
write.csv(univariate_res_control, "healthstate_anova_wsig_control_test_block.txt", row.names = F)

#----only analyze the samples collected from Serum
d_serum <- d[d$Organ == "Serum", ]
#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_serum[,i+5]~ Health_State + Smoking_Status + Gender, data = d_serum)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>F)`[3]
  
  pkimodelseffect[[i]] <- 
    log(mean(2^(d_serum[d_serum$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d_serum[d_serum$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_serum[d_serum$Health_State == "Adenocarcinoma",i+5])
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
plot(pki_ps, pki_effect)
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange, 
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sum(univariate_res_control$significance)
write.csv(univariate_res_control, "healthstate_anova_wsig_control_test_serum.txt", row.names = F)

#----only analyze the samples collected from Serum
d_plasma <- d[d$Organ == "Plasma", ]

#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_plasma[,i+5]~ Health_State + Smoking_Status + Gender, data = d_plasma)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>F)`[3]
  
  pkimodelseffect[[i]] <- 
    log(mean(2^(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5]))/
          mean(2^(d_plasma[d_plasma$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5])
  
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
plot(pki_ps, pki_effect)
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange, 
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sum(univariate_res_control$significance)
write.csv(univariate_res_control, "healthstate_anova_wsig_control_test_plasma.txt", row.names = F)
```


## Try  non-parameteric approach

```{r t-test_comp, cache=T}
#----only analyze the samples collected from Serum
d_serum <- d[d$Organ == "Serum", ]
#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_serum[,i+5]~ Smoking_Status + Gender, data = d_serum)
  pkimodelspvals[[i]] <-   permTS(lmfit$residuals ~ Health_State, data = d_serum,
                                  alternative="two.sided", method="exact.mc",
                                  control=permControl(nmc=10^5))$p.value
  
  pkimodelseffect[[i]] <-
    mean(2^(d_serum[d_serum$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d_serum[d_serum$Health_State == "Healthy",i+5]))
  pkimodelsmean[[i]] <- mean(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5])
}

pki_effect = unlist(pkimodelseffect)
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

pki_ps_raw = unlist(pkimodelspvals)
plot(pki_ps_raw, pki_effect)
pki_ps_adj <- p.adjust(pki_ps_raw, method = "BH")
plot(pki_ps_adj, pki_effect)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps_raw,
                                    adj_pvalues = pki_ps_adj,
                                    FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance_raw <- univariate_res_control$pvalues < .05
univariate_res_control$significance_adj <- univariate_res_control$adj_pvalues < .05
sum(univariate_res_control$significance)
univariate_res_control$variables[univariate_res_control$significance == T]
write.csv(univariate_res_control, "healthstate_anova_wsig_control_test_serum_nonpara.txt", row.names = F)

#----only analyze the samples collected from Serum
d_plasma <- d[d$Organ == "Plasma", ]

#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_plasma[,i+5]~ Smoking_Status + Gender, data = d_plasma)
  pkimodelspvals[[i]] <-   permTS(lmfit$residuals ~ Health_State, data = d_plasma,
                                  alternative="two.sided", method="exact.mc",
                                  control=permControl(nmc=10^5))$p.value
  
  pkimodelseffect[[i]] <-
    mean(2^(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5]))/
          mean(2^(d_plasma[d_plasma$Health_State == "Healthy",i+5]))
  pkimodelsmean[[i]] <- mean(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5])
  
}

pki_effect = unlist(pkimodelseffect)
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

pki_ps_raw = unlist(pkimodelspvals)
plot(pki_ps_raw, pki_effect)
pki_ps_adj <- p.adjust(pki_ps_raw, method = "BH")
plot(pki_ps_adj, pki_effect)

#c
univariate_res_control = data.frame(variables = vars, pvalues = pki_ps_raw,
                                    adj_pvalues = pki_ps_adj,
                                    FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance_raw <- univariate_res_control$pvalues < .05
univariate_res_control$significance_adj <- univariate_res_control$adj_pvalues < .05
sum(univariate_res_control$significance)
univariate_res_control$variables[univariate_res_control$significance == T]
write.csv(univariate_res_control, "healthstate_anova_wsig_control_test_plasma_nonpara.txt", row.names = F)
```

# REDO with no normalization

p-values dont change because dividing by a constant and then taking the log is equivalent to subtracting off a constant, therefore, the differences in the means will be the same

```{r}
# save this processed data frame so you can try different processing
f2 <- before.process

# two metabolites with missing values, use imputation, take half the minimum
# of that metabolite's value
# also, perform log base 2 transformation.  I cannot for the life of me
# figure out how they did their normalization
f2 <- apply(f2, 2, function(x) {
  # idx <- which(is.na(x))
  x[is.na(x)] <- .5*min(na.omit(x))
  # print(x[idx])
  x
})

# # total quantity normalization
# for(i in 1:nrow(f2)){
#   f2[i, ] <- f2[i, ]/sum(f2[i, ])
# }
```

Before and after log transformation of unnormalized data

```{r}
summary(f2[, 1:6])
hist(f2[, "asparagine"])

# log transformation
f2 <- log(f2, base = 2)

summary(f2[, 1:6])
hist(f2[, "asparagine"])
```

```{r, include = F}
# fix compound names so that they are the same
# format as the file provided by Melaine
ids <- sdfid(sdfset)
ids.new <- gsub(" |,","_",ids, perl = T)

# 130 compounds provided
sum(ids.new %in% colnames(f2))
dim(f2)

f2 <- f2[, colnames(f2) %in% ids.new]
rownames(f2) <- sub("X", "", row.names(f2))
d <- merge(f1, f2, by.x= "row.names", by.y = "row.names")

d$Organ <- factor(d$Organ)

#replacing mispelled adenocarcinoma and "Adenosquamous" with Adenocarcinoma
d$Health_State <- gsub("Adenocarcnoma|Adenosquamous", "Adenocarcinoma", d$Health_State)

table(d$Organ, d$Health_State)
table(d$Smoking_Status, d$Health_State)
# table(d$Organ)
# table(d$Smoking_Status)
# table(d$Gender)
# table(d$Health_State)
# table(d$Patient)

# some patients do not have measurements for both plasma and serum
head(xtabs(`1_5-anhydroglucitol` ~ Patient + Organ, d))

row.names(d) <- d$Row.names
d$Row.names <- NULL
```

```{r include= F}
vars = colnames(d)[6:ncol(d)]
varNum <- length(vars)
pkimodels <- vector("list", (varNum))
pkimodelspvals <- vector("list", (varNum))
pkimodelseffect <- vector("list", (varNum))
pkimodelsmean <- vector("list", (varNum))

#----controling for all factors, including organ

for (i in 1:(varNum)){
  lmfit <- lm(d[,i+5]~ Organ + Health_State + Smoking_Status + Gender, data = d)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>F)`[3]
  
  pkimodelseffect[[i]] <- log(mean(2^(d[d$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d[d$Health_State == "Healthy",i+5])), base=2)
  # mins[[i]] <- min(d[,220])
}
pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

## Controling for all factors, including organ

```{r}
plot(pki_ps, pki_effect)
```

```{r, include = F}
log2FoldChange <- pki_effect

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps, log2FoldChange = log2FoldChange)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sig_no_block <- univariate_res_control$pvalues < .05

#-----Using patient as blocking factor

for (i in 1:(varNum)){
  lmfit <- lmer(d[,i+5]~ Organ + Health_State + Smoking_Status + Gender + (1|Patient), data = d)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>Chisq)`[3]
  
  pkimodelseffect[[i]] <- log(mean(2^(d[d$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d[d$Health_State == "Healthy",i+5])), base=2)
  # mins[[i]] <- min(d[,220])
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

## Using patient as blocking factor

```{r}
plot(pki_ps, pki_effect)
```

```{r, include=F}

log2FoldChange <- pki_effect

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps, log2FoldChange = log2FoldChange)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sig_block <- univariate_res_control$pvalues < .05
```
```{r}
table(sig_block, sig_no_block)
```
```{r, include=F}
#----only analyze the samples collected from Serum
d_serum <- d[d$Organ == "Serum", ]
#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_serum[,i+5]~ Health_State + Smoking_Status + Gender, data = d_serum)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>F)`[3]
  pkimodelseffect[[i]] <-
    log(mean(2^(d_serum[d_serum$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d_serum[d_serum$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_serum[d_serum$Health_State == "Adenocarcinoma",i+5])
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

## Only analyze the samples collected from Serum
```{r}
plot(pki_ps, pki_effect)
```

```{r, include=F}
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sum(univariate_res_control$significance)
write.csv(univariate_res_control, "healthstate_anova_wsig_control_test_serum.txt", row.names = F)

#----only analyze the samples collected from Serum
d_plasma <- d[d$Organ == "Plasma", ]

#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_plasma[,i+5]~ Health_State + Smoking_Status + Gender, data = d_plasma)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>F)`[3]
  pkimodelseffect[[i]] <-
    log(mean(2^(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5]))/
          mean(2^(d_plasma[d_plasma$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5])
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

## Only analyze the samples collected from Serum

```{r}
plot(pki_ps, pki_effect)
```

```{r, include = F}
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sum(univariate_res_control$significance)
```


These plots should match the ones in the paper

```{r}
boxplot(d_serum$xylose~d_serum$Health_State, main = "xylose")
stripchart(d_serum$xylose ~ d_serum$Health_State, vertical = TRUE,
           method = "jitter", add = TRUE, pch = 20, col = 'blue')

boxplot(d_serum$glutamic_acid~d_serum$Health_State, main = "glutamate")
stripchart(d_serum$glutamic_acid~d_serum$Health_State, vertical = TRUE,
           method = "jitter", add = TRUE, pch = 20, col = 'blue')

boxplot(d_serum$aspartic_acid~d_serum$Health_State, main = "aspartate")
stripchart(d_serum$aspartic_acid~d_serum$Health_State, vertical = TRUE,
           method = "jitter", add = TRUE, pch = 20, col = 'blue')
```

## Try  non-parameteric approach

```{r t-test_comp_nonorm1, cache=T, echo = F}
#----only analyze the samples collected from Serum
d_serum <- d[d$Organ == "Serum", ]
#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_serum[,i+5]~ Smoking_Status + Gender, data = d_serum)
  pkimodelspvals[[i]] <-   permTS(lmfit$residuals ~ Health_State, data = d_serum,
                                  alternative="two.sided", method="exact.mc",
                                  control=permControl(nmc=10^5))$p.value
  
  pkimodelseffect[[i]] <-
    log(mean(2^(d_serum[d_serum$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d_serum[d_serum$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5])
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

```{r}
plot(pki_ps, pki_effect)
```

```{r t-test_comp_nonorm2, cache=T, echo = F}
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05

#----only analyze the samples collected from Plasma
d_plasma <- d[d$Organ == "Plasma", ]

#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_serum[,i+5]~ Smoking_Status + Gender, data = d_serum)
  pkimodelspvals[[i]] <-   permTS(lmfit$residuals ~ Health_State, data = d_serum,
                                  alternative="two.sided", method="exact.mc",
                                  control=permControl(nmc=10^5))$p.value
  
  pkimodelseffect[[i]] <-
    log(mean(2^(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5]))/
          mean(2^(d_plasma[d_plasma$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5])
  
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

```{r}
plot(pki_ps, pki_effect)
```

```{r, echo=F}
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
```

# REDO no normalization and no log transformation

```{r}
# save this processed data frame so you can try different processing
f2 <- before.process

# two metabolites with missing values, use imputation, take half the minimum
# of that metabolite's value
# also, perform log base 2 transformation.  I cannot for the life of me
# figure out how they did their normalization
f2 <- apply(f2, 2, function(x) {
  # idx <- which(is.na(x))
  x[is.na(x)] <- .5*min(na.omit(x))
  # print(x[idx])
  x
})

# # total quantity normalization
# for(i in 1:nrow(f2)){
#   f2[i, ] <- f2[i, ]/sum(f2[i, ])
# }
```

```{r, include = F}
# fix compound names so that they are the same
# format as the file provided by Melaine
ids <- sdfid(sdfset)
ids.new <- gsub(" |,","_",ids, perl = T)

# 130 compounds provided
sum(ids.new %in% colnames(f2))
dim(f2)

f2 <- f2[, colnames(f2) %in% ids.new]
rownames(f2) <- sub("X", "", row.names(f2))
d <- merge(f1, f2, by.x= "row.names", by.y = "row.names")

d$Organ <- factor(d$Organ)

#replacing mispelled adenocarcinoma and "Adenosquamous" with Adenocarcinoma
d$Health_State <- gsub("Adenocarcnoma|Adenosquamous", "Adenocarcinoma", d$Health_State)

table(d$Organ, d$Health_State)
table(d$Smoking_Status, d$Health_State)
# table(d$Organ)
# table(d$Smoking_Status)
# table(d$Gender)
# table(d$Health_State)
# table(d$Patient)

# some patients do not have measurements for both plasma and serum
head(xtabs(`1_5-anhydroglucitol` ~ Patient + Organ, d))

row.names(d) <- d$Row.names
d$Row.names <- NULL
```

```{r include= F}
vars = colnames(d)[6:ncol(d)]
varNum <- length(vars)
pkimodels <- vector("list", (varNum))
pkimodelspvals <- vector("list", (varNum))
pkimodelseffect <- vector("list", (varNum))
pkimodelsmean <- vector("list", (varNum))

#----controling for all factors, including organ

for (i in 1:(varNum)){
  lmfit <- lm(d[,i+5]~ Organ + Health_State + Smoking_Status + Gender, data = d)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>F)`[3]
  
  pkimodelseffect[[i]] <- log(mean(2^(d[d$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d[d$Health_State == "Healthy",i+5])), base=2)
  # mins[[i]] <- min(d[,220])
}
pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

## Controling for all factors, including organ

```{r}
plot(pki_ps, pki_effect)
```

```{r, include = F}
log2FoldChange <- pki_effect

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps, log2FoldChange = log2FoldChange)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sig_no_block <- univariate_res_control$pvalues < .05

#-----Using patient as blocking factor

for (i in 1:(varNum)){
  lmfit <- lmer(d[,i+5]~ Organ + Health_State + Smoking_Status + Gender + (1|Patient), data = d)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>Chisq)`[3]
  
  pkimodelseffect[[i]] <- log(mean(2^(d[d$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d[d$Health_State == "Healthy",i+5])), base=2)
  # mins[[i]] <- min(d[,220])
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

## Using patient as blocking factor

```{r}
plot(pki_ps, pki_effect)
```

```{r, include=F}

log2FoldChange <- pki_effect

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps, log2FoldChange = log2FoldChange)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sig_block <- univariate_res_control$pvalues < .05
```
```{r}
table(sig_block, sig_no_block)
```
```{r, include=F}
#----only analyze the samples collected from Serum
d_serum <- d[d$Organ == "Serum", ]
#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_serum[,i+5]~ Health_State + Smoking_Status + Gender, data = d_serum)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>F)`[3]
  pkimodelseffect[[i]] <-
    log(mean(2^(d_serum[d_serum$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d_serum[d_serum$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_serum[d_serum$Health_State == "Adenocarcinoma",i+5])
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

## Only analyze the samples collected from Serum
```{r}
plot(pki_ps, pki_effect)
```

```{r, include=F}
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sum(univariate_res_control$significance)
write.csv(univariate_res_control, "healthstate_anova_wsig_control_test_serum.txt", row.names = F)

#----only analyze the samples collected from Serum
d_plasma <- d[d$Organ == "Plasma", ]

#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_plasma[,i+5]~ Health_State + Smoking_Status + Gender, data = d_plasma)
  pkimodels[[i]] <- lmfit
  #pvalue for regressing each variable in df on AC50
  pkimodelspvals[[i]] <- Anova(lmfit, type = "III")$`Pr(>F)`[3]
  pkimodelseffect[[i]] <-
    log(mean(2^(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5]))/
          mean(2^(d_plasma[d_plasma$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5])
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

## Only analyze the samples collected from Serum

```{r}
plot(pki_ps, pki_effect)
```

```{r, include = F}
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
sum(univariate_res_control$significance)
```


These means should match table in paper

```{r}
boxplot(d_serum$xylose~d_serum$Health_State, main = "xylose")
boxplot(d_serum$glutamic_acid~d_serum$Health_State, main = "glutamate")
boxplot(d_serum$aspartic_acid~d_serum$Health_State, main = "aspartate")
```

## Try  non-parameteric approach

```{r t-test_comp_nonorm_orlog1, cache=T, echo = F}
#----only analyze the samples collected from Serum
d_serum <- d[d$Organ == "Serum", ]
#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_serum[,i+5]~ Smoking_Status + Gender, data = d_serum)
  pkimodelspvals[[i]] <-   permTS(lmfit$residuals ~ Health_State, data = d_serum,
                                  alternative="two.sided", method="exact.mc",
                                  control=permControl(nmc=10^5))$p.value
  
  pkimodelseffect[[i]] <-
    log(mean(2^(d_serum[d_serum$Health_State == "Adenocarcinoma",i+5]))/mean(2^(d_serum[d_serum$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5])
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

```{r}
plot(pki_ps, pki_effect)
```

```{r t-test_comp_nonorm_orlog2, cache=T, echo = F}
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05

#----only analyze the samples collected from Plasma
d_plasma <- d[d$Organ == "Plasma", ]

#----controling for all factors
for (i in 1:(varNum)){
  lmfit <- lm(d_serum[,i+5]~ Smoking_Status + Gender, data = d_serum)
  pkimodelspvals[[i]] <-   permTS(lmfit$residuals ~ Health_State, data = d_serum,
                                  alternative="two.sided", method="exact.mc",
                                  control=permControl(nmc=10^5))$p.value
  
  pkimodelseffect[[i]] <-
    log(mean(2^(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5]))/
          mean(2^(d_plasma[d_plasma$Health_State == "Healthy",i+5])), base=2)
  pkimodelsmean[[i]] <- mean(d_plasma[d_plasma$Health_State == "Adenocarcinoma",i+5])
  
}

pki_ps = unlist(pkimodelspvals)
pki_ps <- p.adjust(pki_ps, method = "BH")

pki_effect = unlist(pkimodelseffect)
```

```{r}
plot(pki_ps, pki_effect)
```

```{r, echo=F}
log2FoldChange <- pki_effect
pkimodelsmean <- unlist(pkimodelsmean)

univariate_res_control = data.frame(variables = vars, pvalues = pki_ps,
                                    log2FoldChange = log2FoldChange,
                                    pkimodelsmean = pkimodelsmean)
univariate_res_control$significance <- univariate_res_control$pvalues < .05
```
